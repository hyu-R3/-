# 图书馆管理系统 - 业务流程图

## 1. 用户注册流程

```mermaid
flowchart TD
    A[开始] --> B[用户访问注册页面]
    B --> C{填写注册信息}
    C --> D[输入用户名]
    C --> E[输入密码]
    C --> F[输入姓名]
    C --> G[输入邮箱 可选]
    C --> H[输入电话 可选]
    D & E & F & G & H --> I[点击注册按钮]
    I --> J{前端验证}
    J -->|验证失败| K[显示错误提示]
    K --> C
    J -->|验证成功| L[发送注册请求]
    L --> M[后端检查用户名]
    M --> N{用户名是否存在}
    N -->|是| O[返回错误: 用户名已存在]
    O --> K
    N -->|否| P[bcrypt加密密码]
    P --> Q[插入数据库]
    Q --> R{插入成功}
    R -->|否| S[返回错误: 注册失败]
    S --> K
    R -->|是| T[返回成功信息]
    T --> U[显示注册成功提示]
    U --> V[切换到登录页面]
    V --> W[结束]
```

---

## 2. 用户登录流程

```mermaid
flowchart TD
    A[开始] --> B[用户访问登录页面]
    B --> C{填写登录信息}
    C --> D[输入用户名]
    C --> E[输入密码]
    D & E --> F[点击登录按钮]
    F --> G{前端验证}
    G -->|验证失败| H[显示错误提示]
    H --> C
    G -->|验证成功| I[发送登录请求]
    I --> J[后端查询用户]
    J --> K{用户是否存在}
    K -->|否| L[返回错误: 用户名或密码错误]
    L --> H
    K -->|是| M[bcrypt.compare验证密码]
    M --> N{密码是否正确}
    N -->|否| L
    N -->|是| O[生成用户信息 不含密码]
    O --> P[返回成功信息]
    P --> Q[显示登录成功提示]
    Q --> R[保存用户信息到前端]
    R --> S[隐藏登录页面]
    S --> T[显示主页面]
    T --> U[加载图书列表]
    U --> V[结束]
```

---

## 3. 图书入库流程

```mermaid
flowchart TD
    A[开始] --> B[用户已登录]
    B --> C[点击图书入库按钮]
    C --> D[打开入库模态框]
    D --> E{填写图书信息}
    E --> F[输入ISBN 必填]
    E --> G[输入书名 必填]
    E --> H[输入作者 必填]
    E --> I[输入出版社 可选]
    E --> J[输入出版日期 可选]
    E --> K[输入分类 可选]
    E --> L[输入数量 必填]
    E --> M[输入价格 可选]
    E --> N[输入简介 可选]
    F & G & H & I & J & K & L & M & N --> O[点击确认入库]
    O --> P{前端验证}
    P -->|验证失败| Q[显示错误提示]
    Q --> E
    P -->|验证成功| R[发送入库请求]
    R --> S[后端检查ISBN]
    S --> T{ISBN是否存在}
    T -->|是| U[返回错误: ISBN已存在]
    U --> Q
    T -->|否| V[开启数据库事务]
    V --> W[插入图书记录]
    W --> X{插入成功}
    X -->|否| Y[事务回滚]
    Y --> Z[返回错误: 入库失败]
    Z --> Q
    X -->|是| AA[事务提交]
    AA --> AB[返回成功信息]
    AB --> AC[显示入库成功提示]
    AC --> AD[关闭模态框]
    AD --> AE[清空表单]
    AE --> AF[刷新图书列表]
    AF --> AG[结束]
```

---

## 4. 图书搜索流程

```mermaid
flowchart TD
    A[开始] --> B[用户已登录]
    B --> C[在搜索框输入关键词]
    C --> D{触发搜索}
    D -->|点击搜索按钮| E[发送搜索请求]
    D -->|按回车键| E
    E --> F[后端构建查询]
    F --> G[在title字段模糊匹配]
    G --> H[在author字段模糊匹配]
    H --> I[在isbn字段模糊匹配]
    I --> J[使用OR条件组合]
    J --> K[执行数据库查询]
    K --> L[获取匹配记录数]
    L --> M[应用分页参数]
    M --> N[按入库时间倒序]
    N --> O[返回搜索结果]
    O --> P{是否有结果}
    P -->|否| Q[显示: 暂无图书]
    Q --> R[结束]
    P -->|是| S[渲染图书列表]
    S --> T[显示分页器]
    T --> U[显示结果数量]
    U --> R
```

---

## 5. 图书借阅流程

```mermaid
flowchart TD
    A[开始] --> B[用户已登录]
    B --> C[浏览图书列表]
    C --> D[找到想借的图书]
    D --> E{检查图书状态}
    E -->|已借完| F[显示: 暂无库存]
    F --> G[结束]
    E -->|可借| H[点击借阅按钮]
    H --> I[发送借阅请求]
    I --> J[后端开启数据库事务]
    J --> K[查询图书信息]
    K --> L{图书是否存在}
    L -->|否| M[返回错误: 图书不存在]
    M --> N[显示错误提示]
    N --> G
    L -->|是| O{库存是否大于0}
    O -->|否| P[返回错误: 图书已借完]
    P --> N
    O -->|是| Q[查询用户借阅记录]
    Q --> R{是否已借阅该书}
    R -->|是| S[返回错误: 已借阅该书]
    S --> N
    R -->|否| T[计算应还日期]
    T --> U[当前日期 + 30天]
    U --> V[减少图书库存]
    V --> W[available_quantity - 1]
    W --> X[插入借阅记录]
    X --> Y[状态: borrowed]
    Y --> Z{操作成功}
    Z -->|否| AA[事务回滚]
    AA --> AB[返回错误: 借阅失败]
    AB --> N
    Z -->|是| AC[事务提交]
    AC --> AD[返回成功信息]
    AD --> AE[显示借阅成功提示]
    AE --> AF[刷新图书列表]
    AF --> AG[结束]
```

---

## 6. 图书归还流程

```mermaid
flowchart TD
    A[开始] --> B[用户已登录]
    B --> C[点击我的借阅]
    C --> D[查看借阅记录]
    D --> E[找到要归还的图书]
    E --> F{检查借阅状态}
    F -->|已归还| G[显示: 已归还]
    G --> H[结束]
    F -->|借阅中| I[点击归还按钮]
    I --> J[显示确认对话框]
    J --> K{用户确认}
    K -->|取消| L[关闭对话框]
    L --> H
    K -->|确定| M[发送归还请求]
    M --> N[后端开启数据库事务]
    N --> O[查询借阅记录]
    O --> P{记录是否存在}
    P -->|否| Q[返回错误: 未找到借阅记录]
    Q --> R[显示错误提示]
    R --> H
    P -->|是| S{状态是否为borrowed}
    S -->|否| T[返回错误: 图书已归还]
    T --> R
    S -->|是| U[记录归还时间]
    U --> V[当前时间]
    V --> W[更新借阅记录状态]
    W --> X[status: returned]
    X --> Y[增加图书库存]
    Y --> Z[available_quantity + 1]
    Z --> AA{操作成功}
    AA -->|否| AB[事务回滚]
    AB --> AC[返回错误: 归还失败]
    AC --> R
    AA -->|是| AD[事务提交]
    AD --> AE[返回成功信息]
    AE --> AF[显示归还成功提示]
    AF --> AG[刷新借阅记录]
    AG --> H
```

---

## 7. 借阅记录查询流程

```mermaid
flowchart TD
    A[开始] --> B[用户已登录]
    B --> C[点击我的借阅]
    C --> D[发送查询请求]
    D --> E[后端查询借阅记录]
    E --> F[JOIN图书表获取书名等信息]
    F --> G[WHERE reader_id = 用户ID]
    G --> H[按借阅时间倒序]
    H --> I[应用分页参数]
    I --> J[返回借阅记录]
    J --> K{是否有记录}
    K -->|否| L[显示: 暂无借阅记录]
    L --> M[结束]
    K -->|是| N[渲染借阅记录列表]
    N --> O[显示每条记录信息]
    O --> P[书名 作者 借阅日期 应还日期]
    P --> Q[显示状态]
    Q --> R{状态判断}
    R -->|borrowed| S[显示: 借阅中]
    S --> T[显示归还按钮]
    R -->|returned| U[显示: 已归还]
    T & U --> V[显示分页器]
    V --> W[显示总记录数]
    W --> M
```

---

## 8. 借阅排行榜生成流程

```mermaid
flowchart TD
    A[开始] --> B[用户已登录]
    B --> C[点击借阅排行榜]
    C --> D[发送排行榜请求]
    D --> E[后端执行统计查询]
    E --> F[SELECT图书信息]
    F --> G[LEFT JOIN借阅记录表]
    G --> H[GROUP BY图书ID]
    H --> I[COUNT借阅记录数]
    I --> J[ORDER BY借阅次数 DESC]
    J --> K[LIMIT 10]
    K --> L[返回排行榜数据]
    L --> M{是否有数据}
    M -->|否| N[显示: 暂无数据]
    N --> O[结束]
    M -->|是| P[渲染排行榜]
    P --> Q[显示每本书的排名]
    Q --> R[前三名显示金银铜色]
    R --> S[显示书名 作者]
    S --> T[显示借阅次数]
    T --> O
```

---

## 9. 系统整体业务流程

```mermaid
flowchart TD
    A[系统启动] --> B[初始化数据库]
    B --> C[创建表结构]
    C --> D[创建索引]
    D --> E[启动服务器]
    E --> F[监听3000端口]
    F --> G[等待用户请求]
    
    G --> H{请求类型}
    
    H -->|注册请求| I[用户注册流程]
    I --> G
    
    H -->|登录请求| J[用户登录流程]
    J --> G
    
    H -->|图书入库请求| K[图书入库流程]
    K --> G
    
    H -->|图书搜索请求| L[图书搜索流程]
    L --> G
    
    H -->|借书请求| M[图书借阅流程]
    M --> G
    
    H -->|还书请求| N[图书归还流程]
    N --> G
    
    H -->|借阅记录请求| O[借阅记录查询流程]
    O --> G
    
    H -->|排行榜请求| P[借阅排行榜生成流程]
    P --> G
    
    G --> Q{系统是否关闭}
    Q -->|否| G
    Q -->|是| R[关闭数据库连接]
    R --> S[停止服务器]
    S --> T[结束]
```

---

## 10. 数据库事务处理流程（借阅/归还）

```mermaid
flowchart TD
    A[开始事务] --> B[SET TRANSACTION]
    B --> C[执行操作1]
    C --> D{操作1成功}
    D -->|否| E[ROLLBACK]
    E --> F[返回失败]
    D -->|是| G[执行操作2]
    G --> H{操作2成功}
    H -->|否| E
    H -->|是| I[COMMIT]
    I --> J[返回成功]
    J --> K[结束]
    F --> K
```

### 借阅事务示例
```
操作1: UPDATE books SET available_quantity = available_quantity - 1 WHERE id = ?
操作2: INSERT INTO borrow_records (reader_id, book_id, borrow_date, due_date, status) VALUES (?, ?, ?, ?, ?)
```

### 归还事务示例
```
操作1: UPDATE books SET available_quantity = available_quantity + 1 WHERE id = ?
操作2: UPDATE borrow_records SET return_date = ?, status = 'returned' WHERE id = ?
```

---

## 11. 数据一致性保障流程

```mermaid
flowchart TD
    A[借阅请求] --> B[检查图书库存]
    B --> C{available_quantity > 0}
    C -->|否| D[返回: 图书已借完]
    C -->|是| E[检查用户借阅记录]
    E --> F{是否已借阅该书}
    F -->|是| G[返回: 已借阅该书]
    F -->|否| H[开启事务]
    H --> I[减少库存]
    I --> J[插入借阅记录]
    J --> K{操作成功}
    K -->|否| L[回滚事务]
    L --> M[返回: 借阅失败]
    K -->|是| N[提交事务]
    N --> O[返回: 借阅成功]
    D & G & M & O --> P[结束]
```

---

## 12. 错误处理流程

```mermaid
flowchart TD
    A[API请求] --> B[参数验证]
    B --> C{验证通过}
    C -->|否| D[返回400错误]
    D --> E[显示错误提示]
    C -->|是| F[业务逻辑处理]
    F --> G{处理成功}
    G -->|否| H[返回错误信息]
    H --> I{错误类型}
    I -->|业务错误| J[返回400错误]
    I -->|未授权| K[返回401错误]
    I -->|资源不存在| L[返回404错误]
    I -->|服务器错误| M[返回500错误]
    G -->|是| N[返回成功数据]
    J & K & L & M --> E
    N --> O[显示成功提示]
    E & O --> P[结束]
```

---

## 流程图说明

### 图例
- **矩形**: 表示操作或处理步骤
- **菱形**: 表示判断条件
- **圆角矩形**: 表示开始或结束
- **箭头**: 表示流程方向

### 关键流程说明

1. **事务处理**: 借阅和归还操作都使用数据库事务，确保数据一致性
2. **并发控制**: 通过事务和库存检查，防止超借和库存不一致
3. **错误处理**: 每个流程都有完善的错误处理机制
4. **数据验证**: 前后端双重验证，确保数据有效性
5. **安全性**: 密码使用bcrypt加密，SQL使用参数化查询

### 性能优化点

1. **分页查询**: 所有列表都支持分页
2. **索引优化**: 为常用查询字段创建索引
3. **批量操作**: 使用事务批量执行多个操作
4. **缓存建议**: 热门数据可以缓存（如排行榜）

---

## 使用说明

本流程图使用Mermaid语法编写，可以在以下工具中查看：

1. **GitHub**: 直接在GitHub仓库中查看
2. **VS Code**: 安装Mermaid插件预览
3. **在线工具**: 访问 https://mermaid.live/

### 在VS Code中查看
1. 安装 "Markdown Preview Mermaid Support" 插件
2. 打开本文件
3. 按 Ctrl+Shift+V 预览

### 在线查看
1. 复制流程图代码
2. 访问 https://mermaid.live/
3. 粘贴代码即可查看